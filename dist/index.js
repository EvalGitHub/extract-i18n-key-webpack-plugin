"use strict";const fs=require("fs"),pluginName="ExtractI18nKeyWebpackPlugin",targetJsPattern=/^js\/.+\.js$/gi;class ExtractI18nKeyWebpackPlugin{constructor(t){this.options=t,this.targetKeysList=[]}writeChangeFile(t,e){fs.writeFileSync(e,t,t=>{if(t)throw console.log(t),console.log(e+"文件写入失败！"),t})}handleFileContentForMust(s){let i="";const n=this;var t=this.options["i18nProjectName"];const o=new RegExp(`(("|')key("|'):|id:)(\\n|\\s)*('|")${t}(\\.|\\w|\\-)+`,"g"),r=new RegExp(t+"(\\w|-|\\.)*","g");s.chunks.forEach(function(t){t.files.forEach(function(e){if(e&&targetJsPattern.test(e)){i=s.assets[e].source();let t=i.match(o);Array.isArray(t)&&t.forEach(t=>{t=t.match(r);t&&t[0]&&!n.targetKeysList.includes(t[0])&&n.targetKeysList.push(t[0])})}})})}editCurrentI18nFileContent(t){const e=this.options["waitHandleFileList"],n=this.targetKeysList;Array.isArray(e)&&0<e.length&&e.forEach(e=>{const i=t.compiler.context+"/"+e;fs.access(i,t=>{if(t&&"ENOENT"===t.code)console.error(e+" 文件不存在！");else{const s=require(i);let e=!1;Object.keys(s).forEach(t=>{n.includes(t)||(delete s[t],e=!0)}),e&&this.writeChangeFile(JSON.stringify(s,"","\t"),i)}})})}createKeyListFile(t){var e=this.options["targetFilePath"],s=JSON.stringify(this.targetKeysList,"","\t");const i=t.compiler.context+"/"+e;fs.writeFileSync(i,s,{flag:"w"},t=>{if(t)throw console.log(t),console.log(i+"写入失败！"),t})}apply(t){const{createFile:s,projectType:i}=this.options;t.hooks.emit.tapAsync(pluginName,async(t,e)=>{"must"===i&&this.handleFileContentForMust(t),e()}),t.hooks.afterEmit.tapAsync(pluginName,async(t,e)=>{this.editCurrentI18nFileContent(t),s&&this.createKeyListFile(t),e()})}}module.exports=ExtractI18nKeyWebpackPlugin;
//# sourceMappingURL=index.js.map

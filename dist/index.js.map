{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/**\n *  1. 抽取项目中所有正在使用的i18n key, 去除没使用的i18n\n *  2. 替换i18n key 缩短文件大小\n *  减小i18n文件体积\n */\nconst fs = require('fs');\n\nconst pluginName = 'ExtractI18nKeyWebpackPlugin';\nconst targetJsPattern = /^js\\/.+\\.js$/gi; // 目标js文件\n// const p1 = /\\.get\\(\\{(\\n|\\s)*id:(\\n|\\s)*((\\'|\\\"|\\.|\\w|\\-)+)/gi;\n// const p2 = /(id:|key:)(\\n|\\s)*(\\'|\\\"|\\.|\\w|\\-)+/g;\n// const p3 = /('|'')\\n*(\\w|-)*[^,]*/gi;\n// const p4 = /[\\w|\\-|\\.]+/gi;\n\nclass ExtractI18nKeyWebpackPlugin {\n  constructor(options) {\n    this.options = options;\n    this.targetKeysList = [];\n  }\n\n  writeChangeFile(fileContent, filePath) {\n    fs.writeFileSync(filePath, fileContent, (err) => {\n      if (err) {\n        console.log(err);\n        console.log(`${filePath}文件写入失败！`);\n        throw err;\n      }\n    });\n  }\n\n  // must应用\n  handleFileContentForMust(compilation) {\n    let sourceString = '';\n    const _this = this;\n    const { i18nProjectName } = this.options;\n    const pattern_str = new RegExp(\n      `((\"|')key(\"|'):|id:)?(\\\\n|\\\\s)*('|\")${i18nProjectName}(\\\\.|\\\\w|\\\\-)+`,\n      'g'\n    );\n    const pattern_str02 = new RegExp(`${i18nProjectName}(\\\\w|-|\\\\.)*`, 'g');\n    compilation.chunks.forEach(function (chunk) {\n      chunk.files.forEach(function (filename) {\n        // compilation.assets 存放当前所有即将输出的资源\n        // 调用一个输出资源的 source() 方法能获取到输出资源的内容\n        if (filename && targetJsPattern.test(filename)) {\n          sourceString = compilation.assets[filename].source();\n          let _temArr = sourceString.match(pattern_str);\n          Array.isArray(_temArr) &&\n            _temArr.forEach((item) => {\n              let targetItem = item.match(pattern_str02);\n              if (\n                targetItem &&\n                targetItem[0] &&\n                !_this.targetKeysList.includes(targetItem[0])\n              ) {\n                _this.targetKeysList.push(targetItem[0]);\n              }\n            });\n        }\n      });\n    });\n  }\n\n  editCurrentI18nFileContent(compilation) {\n    const { waitHandleFileList } = this.options;\n    const targetKeysList = this.targetKeysList;\n    if (Array.isArray(waitHandleFileList) && waitHandleFileList.length > 0) {\n      waitHandleFileList.forEach((itemFile) => {\n        const filePath = `${compilation.compiler.context}/${itemFile}`;\n        fs.access(filePath, (err) => {\n          if (err && err.code === 'ENOENT') {\n            console.error(`${itemFile} 文件不存在！`);\n            return;\n          }\n          const JSON_CONTENT = require(filePath);\n          let changeFile = false;\n          Object.keys(JSON_CONTENT).forEach((item) => {\n            if (!targetKeysList.includes(item)) {\n              delete JSON_CONTENT[item];\n              changeFile = true;\n            }\n          });\n          changeFile &&\n            this.writeChangeFile(\n              JSON.stringify(JSON_CONTENT, '', '\\t'),\n              filePath\n            );\n        });\n      });\n    }\n  }\n\n  createKeyListFile(compilation) {\n    const { targetFilePath } = this.options;\n    const _data = JSON.stringify(this.targetKeysList, '', '\\t');\n    const filePath = `${compilation.compiler.context}/${targetFilePath}`;\n\n    fs.writeFileSync(filePath, _data, { flag: 'w' }, (err) => {\n      if (err) {\n        console.log(err);\n        console.log(`${filePath}写入失败！`);\n        throw err;\n      }\n    });\n  }\n\n  apply(compiler) {\n    const { createFile, projectType } = this.options;\n\n    compiler.hooks.emit.tapAsync(pluginName, async (compilation, callback) => {\n      if (projectType === 'must') {\n        // must应用\n        this.handleFileContentForMust(compilation);\n      }\n      callback();\n    });\n\n    compiler.hooks.afterEmit.tapAsync(\n      pluginName,\n      async (compilation, callback) => {\n        this.editCurrentI18nFileContent(compilation);\n        createFile && this.createKeyListFile(compilation);\n        callback();\n      }\n    );\n  }\n}\n\nmodule.exports = ExtractI18nKeyWebpackPlugin;\n"],"names":["fs","require","pluginName","targetJsPattern","ExtractI18nKeyWebpackPlugin","constructor","options","this","targetKeysList","writeChangeFile","fileContent","filePath","writeFileSync","err","console","log","handleFileContentForMust","compilation","let","sourceString","_this","i18nProjectName","pattern_str","RegExp","pattern_str02","chunks","forEach","chunk","files","filename","test","assets","source","_temArr","match","Array","isArray","targetItem","item","includes","push","editCurrentI18nFileContent","waitHandleFileList","length","compiler","context","itemFile","access","code","error","JSON_CONTENT","changeFile","Object","keys","JSON","stringify","createKeyListFile","targetFilePath","_data","flag","apply","createFile","projectType","hooks","emit","tapAsync","async","callback","afterEmit","module","exports"],"mappings":"aAKA,MAAMA,GAAKC,QAAQ,MAEbC,WAAa,8BACbC,gBAAkB,uBAMlBC,4BACJC,YAAYC,GACVC,KAAKD,QAAUA,EACfC,KAAKC,eAAiB,GAGxBC,gBAAgBC,EAAaC,GAC3BX,GAAGY,cAAcD,EAAUD,EAAa,IACtC,GAAIG,EAGF,MAFAC,QAAQC,IAAIF,GACZC,QAAQC,IAAOJ,EAAH,WACNE,IAMZG,yBAAyBC,GACvBC,IAAIC,EAAe,GACnB,MAAMC,EAAQb,KACd,IAAQc,EAAoBd,KAAKD,QAAzBe,mBACR,MAAMC,EAAc,IAAIC,8CACiBF,kBACvC,KAEIG,EAAgB,IAAID,OAAUF,EAAH,eAAkC,KACnEJ,EAAYQ,OAAOC,QAAQ,SAAUC,GACnCA,EAAMC,MAAMF,QAAQ,SAAUG,GAG5B,GAAIA,GAAY1B,gBAAgB2B,KAAKD,GAAW,CAC9CV,EAAeF,EAAYc,OAAOF,GAAUG,SAC5Cd,IAAIe,EAAUd,EAAae,MAAMZ,GACjCa,MAAMC,QAAQH,IACZA,EAAQP,QAAQ,IACVW,EAAaC,EAAKJ,MAAMV,GAE1Ba,GACAA,EAAW,KACVjB,EAAMZ,eAAe+B,SAASF,EAAW,KAE1CjB,EAAMZ,eAAegC,KAAKH,EAAW,WAQnDI,2BAA2BxB,GACzB,MAAQyB,EAAuBnC,KAAKD,QAA5BoC,sBACFlC,EAAiBD,KAAKC,eACxB2B,MAAMC,QAAQM,IAAmD,EAA5BA,EAAmBC,QAC1DD,EAAmBhB,QAAQ,IACzB,MAAMf,EAAcM,EAAY2B,SAASC,QAAxB,IAAmCC,EACpD9C,GAAG+C,OAAOpC,EAAU,IAClB,GAAIE,GAAoB,WAAbA,EAAImC,KACblC,QAAQmC,MAASH,EAAH,eADhB,CAIA,MAAMI,EAAejD,QAAQU,GAC7BO,IAAIiC,GAAa,EACjBC,OAAOC,KAAKH,GAAcxB,QAAQ,IAC3BlB,EAAe+B,SAASD,YACpBY,EAAaZ,GACpBa,GAAa,KAGjBA,GACE5C,KAAKE,gBACH6C,KAAKC,UAAUL,EAAc,GAAI,MACjCvC,QAOZ6C,kBAAkBvC,GAChB,IAAQwC,EAAmBlD,KAAKD,QAAxBmD,kBACFC,EAAQJ,KAAKC,UAAUhD,KAAKC,eAAgB,GAAI,MACtD,MAAMG,EAAcM,EAAY2B,SAASC,QAAxB,IAAmCY,EAEpDzD,GAAGY,cAAcD,EAAU+C,EAAO,CAAEC,KAAM,KAAO,IAC/C,GAAI9C,EAGF,MAFAC,QAAQC,IAAIF,GACZC,QAAQC,IAAOJ,EAAH,SACNE,IAKZ+C,MAAMhB,GACJ,KAAM,CAAEiB,WAAAA,EAAYC,YAAAA,GAAgBvD,KAAKD,QAEzCsC,EAASmB,MAAMC,KAAKC,SAAS/D,WAAYgE,MAAOjD,EAAakD,KACvC,SAAhBL,GAEFvD,KAAKS,yBAAyBC,GAEhCkD,MAGFvB,EAASmB,MAAMK,UAAUH,SACvB/D,WACAgE,MAAOjD,EAAakD,KAClB5D,KAAKkC,2BAA2BxB,GAChC4C,GAActD,KAAKiD,kBAAkBvC,GACrCkD,OAMRE,OAAOC,QAAUlE"}